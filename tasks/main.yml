---
# Variable setup.
- name: Include OS-specific variables.
  include_vars: "{{ ansible_os_family }}.yml"

# Setup/install tasks.
- include: setup-Debian.yml
  when: ansible_os_family == 'Debian'

# Pure-FTPd setup
- name: Create the FTP system group '{{ ftp_group }}'
  group: name={{ ftp_group }} state=present

- name: Create the FTP system user '{{ ftp_user }}'
  user: name={{ ftp_user }} group={{ ftp_group }} home=/dev/null shell=/sbin/nologin state=present

- name: Create FTP server root directory '{{ ftp_root }}'
  file: dest={{ ftp_root }} mode=0755 state=directory owner={{ ftp_user }} group={{ ftp_group}}

- name: Set TLS config level
  copy: content=2 dest={{ __ftp_conf_root }}/TLS owner=root group=root

- name: Install configured TLS PEM for pure-ftpd
  no_log: True
  copy: content="{{ pure_ftpd_pem }}" dest=/etc/ssl/private/pure-ftpd.pem owner=root group=root
  when: pure_ftpd_pem is defined

- name: Generate TLS PEM for pure-ftpd
  expect:
    command: openssl req -x509 -nodes -days {{ openssl_config.days }} -newkey rsa:{{ openssl_config.size }} -keyout /etc/ssl/private/pure-ftpd.pem -out /etc/ssl/private/pure-ftpd.pem
    responses:
      (?i)country name: "{{ openssl_config.country }}"
      (?i)state or province name: "{{ openssl_config.state }}"
      (?i)locality name: "{{ openssl_config.locality }}"
      (?i)organization name: "{{ openssl_config.org }}"
      (?i)organizational unit name: "{{ openssl_config.unit }}"
      (?i)common name: "{{ openssl_config.common }}"
      (?i)email address: "{{ openssl_config.email }}"
  when: pure_ftpd_pem is not defined

- name: Restrict permissions on PEM
  file: state=file path=/etc/ssl/private/pure-ftpd.pem mode=0600 owner=root group=root

# Create the virtual FTP users and set their passwords
- include: virtual-user.yml
  with_items: "{{ virtual_users }}"

#- name: Create virtual FTP user database
#  command: pure-pw mkdb

- name: Link virtual FTP user database to the correct location
  file: src={{ __ftp_user_db }} dest={{ __ftp_user_db_sym }} state=link

- name: Restart pure-ftpd to pick up configuration changes
  service: name=pure-ftpd state=restarted

# - Ensure that FTP service is running
- name: Ensure pure-ftpd is started and enabled to start at boot.
  service: name=pure-ftpd state=started enabled=yes
